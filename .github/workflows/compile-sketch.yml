name: Arduino CI Build

on:
  push:
    branches:
      - main
    paths:
      - 'eSW/FFRESW/FFRESW/FFRESW.ino'
      - 'eSW/libraries/**'
      - '.github/workflows/**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Install AVR GCC and Make
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-avr avr-libc make

      - name: Set up Arduino libraries
        run: |
          mkdir -p ~/.arduino/libraries
          cp -r eSW/libraries/* ~/.arduino/libraries/
          ls ~/.arduino/libraries  # Verify libraries are copied

      - name: Generate Sloeber.ino.cpp file
        run: |
          echo "#ifdef __IN_ECLIPSE__" > eSW/FFRESW/FFRESW/Sloeber.ino.cpp
          echo "// Automatically generated by CI" >> eSW/FFRESW/FFRESW/Sloeber.ino.cpp
          echo "#include \"Arduino.h\"" >> eSW/FFRESW/FFRESW/Sloeber.ino.cpp
          echo "#include \"FFRESW.ino\"" >> eSW/FFRESW/FFRESW/Sloeber.ino.cpp
          echo "#endif" >> eSW/FFRESW/FFRESW/Sloeber.ino.cpp

      - name: Build the project
        run: |
          cd eSW/FFRESW/FFRESW/
          make clean   # Clean any previous builds
          make         # Run the Makefile to build

      - name: Show build info
        run: |
          cd eSW/FFRESW/FFRESW/
          echo 'Build finished. Showing file sizes:'
          avr-size -A Release/FFRESW.elf  # Display the size of the .elf file
          ls -lh Release/FFRESW.elf       # Display file details of the generated .elf
